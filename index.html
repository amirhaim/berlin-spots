<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="theme-color" content="#1a252f"/>
<title>ğŸ‡©ğŸ‡ª Berlin Spots</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;font-family:'Segoe UI',system-ui,sans-serif;direction:rtl;overflow:hidden;background:#f0f2f5}
input,textarea,button,select{font-family:inherit}
button{cursor:pointer}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-thumb{background:#ddd;border-radius:10px}

/* â”€â”€ Animations â”€â”€ */
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.spin{display:inline-block;width:14px;height:14px;border:2px solid #ffffff44;border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESKTOP LAYOUT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#layout{display:flex;height:100vh;overflow:hidden}
#sidebar{width:300px;min-width:300px;display:flex;flex-direction:column;background:white;box-shadow:2px 0 20px rgba(0,0,0,.12);z-index:10;transition:width .3s,min-width .3s;overflow:hidden}
#sidebar.closed{width:0!important;min-width:0!important}
#map-wrap{flex:1;position:relative}
#map{width:100%;height:100%}
#sb-toggle{position:absolute;top:14px;right:14px;z-index:500;background:white;border:none;border-radius:10px;padding:8px 13px;box-shadow:0 2px 12px rgba(0,0,0,.15);font-size:15px}
#sb-header{background:linear-gradient(135deg,#1a252f,#2980b9);color:white;padding:15px 14px 12px;flex-shrink:0}
#sb-filters{padding:8px 10px;border-bottom:1px solid #f0f0f0;display:flex;gap:5px;flex-wrap:wrap;flex-shrink:0}
#sb-list{flex:1;overflow-y:auto}
.row{padding:12px 14px;border-bottom:1px solid #f5f5f5;cursor:pointer;border-right:4px solid transparent;transition:background .12s}
.row:active{background:#f0f6ff}
.row.sel{background:#edf6ff}

/* â”€â”€ Desktop Detail Card â”€â”€ */
#detail{display:none;position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:white;border-radius:22px;padding:22px;width:min(410px,95vw);max-height:75vh;overflow-y:auto;box-shadow:0 16px 50px rgba(0,0,0,.22);z-index:400;direction:rtl}
#detail.on{display:block}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OVERLAY / MODAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:2000;align-items:flex-end;justify-content:center}
#overlay.on{display:flex;animation:fadeIn .18s ease}
.modal{background:white;border-radius:22px 22px 0 0;padding:20px 20px 0;width:100%;max-width:500px;max-height:92vh;overflow-y:auto;direction:rtl;animation:slideUp .25s ease;padding-bottom:env(safe-area-inset-bottom,16px)}
.modal-handle{width:36px;height:4px;background:#e0e0e0;border-radius:4px;margin:0 auto 18px}
/* On desktop modals look like centered dialogs */
@media(min-width:600px){
  #overlay{align-items:center}
  .modal{border-radius:22px;max-height:88vh;padding-bottom:24px}
  .modal-handle{display:none}
}

/* â”€â”€ Shared UI bits â”€â”€ */
.lbl{font-size:11px;font-weight:700;color:#888;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px;display:block}
.inp{width:100%;padding:12px 14px;border-radius:12px;border:1.5px solid #e8e8e8;font-size:15px;outline:none;margin-bottom:14px;transition:border-color .15s;background:white}
.inp:focus{border-color:#2980b9}
.catbtn{padding:5px 10px;border-radius:20px;border:1.5px solid #e8e8e8;background:white;color:#666;font-size:11px;transition:all .15s;white-space:nowrap}
.navbtn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:12px 6px;border-radius:14px;text-decoration:none;color:white;font-size:11px;font-weight:700;transition:opacity .15s}
.navbtn:active{opacity:.8}
.bigbtn{width:100%;padding:15px;border-radius:14px;border:none;font-size:16px;font-weight:800;transition:opacity .15s}
.bigbtn:active{opacity:.85}
.tag-pill{display:inline-flex;align-items:center;padding:5px 12px;border-radius:20px;border:1.5px solid #e0e0e0;background:white;color:#888;font-size:13px;transition:all .15s;white-space:nowrap}
.tag-pill.on{border-color:#3498db;background:#eaf5ff;color:#2980b9;font-weight:600}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE LAYOUT  (â‰¤ 640px)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:640px){
  /* Hide desktop sidebar entirely */
  #sidebar{display:none!important}
  #sb-toggle{display:none!important}
  #detail{display:none!important}

  /* Map takes full screen */
  #layout{flex-direction:column}
  #map-wrap{flex:1;position:relative}
  #map{width:100%;height:100%}

  /* â”€â”€ Top bar â”€â”€ */
  #mobile-topbar{
    display:flex;
    position:absolute;top:0;left:0;right:0;
    background:linear-gradient(135deg,#1a252f,#2980b9);
    color:white;padding:12px 14px;padding-top:max(12px,env(safe-area-inset-top));
    align-items:center;justify-content:space-between;
    z-index:400;box-shadow:0 2px 12px rgba(0,0,0,.2)
  }

  /* â”€â”€ FAB (Add button) â”€â”€ */
  #mobile-fab{
    display:flex;
    position:absolute;bottom:90px;left:16px;
    width:56px;height:56px;border-radius:50%;
    background:#e74c3c;color:white;border:none;
    font-size:28px;align-items:center;justify-content:center;
    box-shadow:0 4px 18px rgba(231,76,60,.5);
    z-index:400;transition:transform .15s
  }
  #mobile-fab:active{transform:scale(.92)}

  /* â”€â”€ Bottom sheet (list) â”€â”€ */
  #mobile-sheet{
    position:absolute;bottom:60px;left:0;right:0;
    background:white;border-radius:20px 20px 0 0;
    box-shadow:0 -4px 24px rgba(0,0,0,.15);
    z-index:400;
    height:85vh;display:flex;flex-direction:column;
    will-change:transform
  }

  /* Sheet handle area - bigger touch target */
  #sheet-handle-area{
    padding:12px 0 4px;flex-shrink:0;cursor:grab;user-select:none;-webkit-user-select:none
  }
  #sheet-handle{
    width:44px;height:5px;background:#d0d0d0;border-radius:4px;margin:0 auto
  }
  #sheet-peek{
    display:flex;align-items:center;justify-content:space-between;
    padding:4px 16px 10px;flex-shrink:0
  }
  #sheet-filters{
    padding:0 12px 10px;display:flex;gap:6px;overflow-x:auto;flex-shrink:0;
    scrollbar-width:none
  }
  #sheet-filters::-webkit-scrollbar{display:none}
  #sheet-list{flex:1;overflow-y:auto;min-height:0;-webkit-overflow-scrolling:touch}

  /* â”€â”€ Mobile detail bottom sheet â”€â”€ */
  #mobile-detail{
    display:none;
    position:absolute;bottom:60px;left:0;right:0;
    background:white;border-radius:20px 20px 0 0;
    padding:16px 18px 20px;
    box-shadow:0 -4px 30px rgba(0,0,0,.18);
    z-index:500;max-height:75vh;overflow-y:auto;
    animation:slideUp .22s ease;
    -webkit-overflow-scrolling:touch
  }
  #mobile-detail.on{display:block}

  /* â”€â”€ Bottom tab bar â”€â”€ */
  #mobile-tabs{
    display:flex;
    position:absolute;bottom:0;left:0;right:0;
    height:60px;
    background:white;border-top:1px solid #efefef;
    padding-bottom:env(safe-area-inset-bottom,0px);
    z-index:450;box-shadow:0 -2px 12px rgba(0,0,0,.07)
  }
  .tab-btn{
    flex:1;display:flex;flex-direction:column;align-items:center;
    gap:2px;padding:8px 4px;border:none;background:none;
    font-size:10px;font-weight:600;color:#bbb;transition:color .15s
  }
  .tab-btn.active{color:#2980b9}
  .tab-btn span{font-size:22px;line-height:1}

  /* FAB above tab bar */
  #mobile-fab{
    bottom:76px
  }

/* Hide mobile elements on desktop */
#mobile-topbar,#mobile-fab,#mobile-sheet,#mobile-detail,#mobile-tabs{display:none}

/* On mobile: always show layout (so map is visible), hide desktop sidebar */
@media(max-width:640px){
  #layout{display:flex!important}
  #sidebar{display:none!important}
  #sb-toggle{display:none!important}
  #detail{display:none!important}
}
</style>
</head>
<body>

<!-- â•â• DESKTOP LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layout" style="display:none">
  <div id="sidebar">
    <div id="sb-header"></div>
    <div id="sb-filters"></div>
    <div id="sb-list"></div>
  </div>
  <div id="map-wrap">
    <div id="map"></div>
    <button id="sb-toggle" onclick="toggleSidebar()">â—€</button>
    <div id="detail"></div>
  </div>
</div>

<!-- â•â• MOBILE LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- Top bar -->
<div id="mobile-topbar">
  <div>
    <div style="font-size:16px;font-weight:800">ğŸ‡©ğŸ‡ª Berlin Spots</div>
    <div style="display:flex;align-items:center;gap:5px;margin-top:2px">
      <div id="m-status-dot" style="width:6px;height:6px;border-radius:50%;background:#f39c12;flex-shrink:0"></div>
      <div id="m-status-text" style="font-size:10px;opacity:.8">×˜×•×¢×Ÿ...</div>
    </div>
  </div>
  <div style="display:flex;gap:8px" id="m-header-btns"></div>
</div>

<!-- FAB add button (admin only) -->
<button id="mobile-fab" onclick="openAdd()" style="display:none">+</button>

<!-- Bottom sheet with place list -->
<div id="mobile-sheet">
  <div id="sheet-handle-area" onclick="toggleSheet()">
    <div id="sheet-handle"></div>
  </div>
  <div id="sheet-peek">
    <div id="sheet-title" style="font-weight:700;font-size:15px;color:#1a252f">ğŸ“ ×”××§×•××•×ª ×©×œ×™</div>
    <div id="sheet-count" style="font-size:12px;color:#aaa"></div>
  </div>
  <div id="sheet-filters"></div>
  <div id="sheet-list"></div>
</div>

<!-- Mobile detail panel -->
<div id="mobile-detail"></div>

<!-- Bottom tab bar -->
<div id="mobile-tabs">
  <button class="tab-btn active" id="tab-map" onclick="switchTab('map')"><span>ğŸ—ºï¸</span>××¤×”</button>
  <button class="tab-btn" id="tab-list" onclick="switchTab('list')"><span>ğŸ“‹</span>×¨×©×™××”</button>
  <button class="tab-btn" id="tab-login" onclick="IS_ADMIN?openShare():showLogin()"><span id="tab-login-icon">ğŸ”‘</span><span id="tab-login-label">×›× ×™×¡×”</span></button>
</div>

<!-- â•â• MODAL OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="overlay"><div id="modal-box"></div></div>

<script>
'use strict';

// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var JAPI = 'https://api.jsonbin.io/v3';
var IS_MOBILE = window.innerWidth <= 640;
window.addEventListener('resize', function(){ IS_MOBILE = window.innerWidth <= 640; });

var CAT = {
  food:       {label:'××¡×¢×“×•×ª',   color:'#e74c3c', emoji:'ğŸ½ï¸'},
  cafe:       {label:'×§×¤×”',      color:'#8B5A14', emoji:'â˜•'},
  bar:        {label:'×‘×¨×™×',     color:'#8e44ad', emoji:'ğŸº'},
  club:       {label:'××•×¢×“×•× ×™×', color:'#c0392b', emoji:'ğŸ·'},
  hotel:      {label:'××œ×•× ×•×ª',   color:'#16a085', emoji:'ğŸ¨'},
  attraction: {label:'××˜×¨×§×¦×™×•×ª', color:'#2980b9', emoji:'ğŸ›ï¸'},
  shopping:   {label:'×§× ×™×•×ª',    color:'#e67e22', emoji:'ğŸ›ï¸'},
  park:       {label:'×¤××¨×§×™×',   color:'#27ae60', emoji:'ğŸŒ³'}
};
var TAGS = ['××•×•×™×¨×” ××’× ×™×‘×”','×–×•×œ','×™×§×¨','××•××œ×¥ ×‘×—×•×','×¨×•×× ×˜×™','×¢× ×—×‘×¨×™×','××™× ×¡×˜×’×¨××‘×™','×©×§×˜','×¨×•×¢×©','×”×™×¤×¡×˜×¨×™','××§×•××™','×’×³××–','×˜×›× ×•','×¢× × ×•×£','×•×’×× ×™'];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var CFG = {};
try { CFG = JSON.parse(localStorage.getItem('bs-cfg')||'{}'); } catch(e){}
var PLACES=[], SEL=null, FILTER='all', IS_ADMIN=false, SB_OPEN=true;
var AF={}, HITS=[], SMODE='search';

// â”€â”€ Leaflet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var MAP=null, MARKERS={};

function initMap() {
  if (MAP) return;
  var el = IS_MOBILE ? document.getElementById('map') : document.getElementById('map');
  MAP = L.map('map',{zoomControl:false}).setView([52.515,13.405],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap',maxZoom:19}).addTo(MAP);
  L.control.zoom({position:'bottomright'}).addTo(MAP);
}

function syncMarkers() {
  if (!MAP) return;
  Object.values(MARKERS).forEach(function(m){m.remove();});
  MARKERS={};
  var vis = FILTER==='all' ? PLACES : PLACES.filter(function(p){return p.category===FILTER;});
  vis.forEach(function(place){
    var cat=CAT[place.category]||CAT.food;
    var isSel=SEL&&SEL.id===place.id;
    var sz=isSel?48:38;
    var icon=L.divIcon({className:'',
      html:'<div style="background:'+cat.color+';color:white;border-radius:50%;width:'+sz+'px;height:'+sz+'px;display:flex;align-items:center;justify-content:center;font-size:'+(isSel?24:19)+'px;box-shadow:0 4px 16px rgba(0,0,0,.35);border:'+(isSel?3:2)+'px solid white">'+cat.emoji+'</div>',
      iconSize:[sz,sz],iconAnchor:[sz/2,sz/2]});
    var m=L.marker([place.lat,place.lng],{icon:icon}).addTo(MAP);
    (function(p){
      m.on('click',function(){
        SEL=p;
        renderList(); renderDetail(); syncMarkers();
        MAP.flyTo([p.lat,p.lng],16,{duration:0.5});
        if (IS_MOBILE) {
          collapseSheet();
          showMobileDetail(p);
        }
      });
    })(place);
    MARKERS[place.id]=m;
  });
}

function toggleSidebar() {
  SB_OPEN=!SB_OPEN;
  document.getElementById('sidebar').className=SB_OPEN?'':'closed';
  document.getElementById('sb-toggle').textContent=SB_OPEN?'â—€':'â–¶';
  setTimeout(function(){if(MAP)MAP.invalidateSize();},310);
}

// â”€â”€ Mobile sheet smooth drag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var _sheet = null;
var _sheetH = 0;          // full height of sheet element
var _sheetY = 0;          // current translateY (0 = fully open, _sheetH-PEEK = peeking)
var PEEK = 70;            // px visible when closed

var _drag = {
  active: false,
  startY: 0,
  startSheetY: 0,
  lastY: 0,
  lastT: 0,
  velocity: 0
};

function sheetSetY(y, animated) {
  if (!_sheet) return;
  var max = _sheetH - PEEK;
  y = Math.max(0, Math.min(max, y));
  _sheetY = y;
  if (animated) {
    _sheet.style.transition = 'transform .32s cubic-bezier(.4,0,.2,1)';
    setTimeout(function(){ _sheet.style.transition = ''; }, 340);
  } else {
    _sheet.style.transition = 'none';
  }
  _sheet.style.transform = 'translateY(' + y + 'px)';
  if (MAP) setTimeout(function(){ MAP.invalidateSize(); }, 340);
}

function initSheetDrag() {
  _sheet = document.getElementById('mobile-sheet');
  if (!_sheet) return;
  _sheetH = _sheet.offsetHeight || window.innerHeight * 0.85;

  // Start peeking
  sheetSetY(_sheetH - PEEK, false);

  var handle = document.getElementById('sheet-handle-area');

  function onMove(clientY) {
    if (!_drag.active) return;
    var now = Date.now();
    var dt = now - _drag.lastT;
    if (dt > 0) _drag.velocity = (clientY - _drag.lastY) / dt; // px/ms
    _drag.lastY = clientY;
    _drag.lastT = now;
    var delta = clientY - _drag.startY;
    sheetSetY(_drag.startSheetY + delta, false);
  }

  function onEnd() {
    if (!_drag.active) return;
    _drag.active = false;
    _sheet.style.cursor = '';
    // Snap: velocity > 0.5 px/ms = flick down â†’ close; < -0.5 = flick up â†’ open
    var v = _drag.velocity;
    var mid = (_sheetH - PEEK) / 2;
    if (v > 0.4 || (v >= 0 && _sheetY > mid)) {
      sheetSetY(_sheetH - PEEK, true); // snap to peek
    } else {
      sheetSetY(0, true); // snap to fully open
    }
  }

  // Touch
  handle.addEventListener('touchstart', function(e) {
    var t = e.touches[0];
    _drag.active = true;
    _drag.startY = t.clientY;
    _drag.startSheetY = _sheetY;
    _drag.lastY = t.clientY;
    _drag.lastT = Date.now();
    _drag.velocity = 0;
    _sheet.style.transition = 'none';
    e.preventDefault();
  }, {passive: false});

  handle.addEventListener('touchmove', function(e) {
    onMove(e.touches[0].clientY);
    e.preventDefault();
  }, {passive: false});

  handle.addEventListener('touchend', function(e) {
    onEnd();
  }, {passive: true});

  // Mouse (desktop testing)
  handle.addEventListener('mousedown', function(e) {
    _drag.active = true;
    _drag.startY = e.clientY;
    _drag.startSheetY = _sheetY;
    _drag.lastY = e.clientY;
    _drag.lastT = Date.now();
    _drag.velocity = 0;
    _sheet.style.cursor = 'grabbing';
    _sheet.style.transition = 'none';
  });
  document.addEventListener('mousemove', function(e) { onMove(e.clientY); });
  document.addEventListener('mouseup', function() { onEnd(); });
}

function setSheetState(state) {
  if (!_sheet) return;
  if (state === 'expanded') sheetSetY(0, true);
  else sheetSetY(_sheetH - PEEK, true);
}
function expandSheet()  { setSheetState('expanded'); }
function collapseSheet(){ setSheetState('peek'); }
function toggleSheet()  { setSheetState(_sheetY < (_sheetH - PEEK) / 2 ? 'peek' : 'expanded'); }

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(function(b){b.className='tab-btn';});
  document.getElementById('tab-'+tab).className='tab-btn active';
  if (tab==='map') {
    collapseSheet();
    hideMobileDetail();
  } else if (tab==='list') {
    hideMobileDetail();
    setSheetState('half');
  }
}

// â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(color, text) {
  // Desktop
  var dot=document.getElementById('status-dot');
  var txt=document.getElementById('status-text');
  if(dot)dot.style.background=color;
  if(txt)txt.textContent=text;
  // Mobile
  var mdot=document.getElementById('m-status-dot');
  var mtxt=document.getElementById('m-status-text');
  if(mdot)mdot.style.background=color;
  if(mtxt)mtxt.textContent=text;
  // Sheet count
  var sc=document.getElementById('sheet-count');
  if(sc)sc.textContent=text;
}

// â”€â”€ Mobile header buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMobileHeader() {
  var el=document.getElementById('m-header-btns');
  if(!el)return;
  if (IS_ADMIN) {
    el.innerHTML='<button onclick="openShare()" style="background:rgba(255,255,255,.15);color:white;border:none;border-radius:10px;padding:8px 12px;font-size:15px">ğŸ”—</button>';
    var fab=document.getElementById('mobile-fab');
    if(fab)fab.style.display='flex';
    // Update tab
    document.getElementById('tab-login-icon').textContent='ğŸ”—';
    document.getElementById('tab-login-label').textContent='×©×ª×£';
  } else {
    el.innerHTML='<button onclick="showLogin()" style="background:rgba(255,255,255,.15);color:white;border:none;border-radius:10px;padding:8px 12px;font-size:12px;font-weight:600">ğŸ”‘ ×›× ×™×¡×”</button>';
  }
}

// â”€â”€ Desktop header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHeader() {
  var hdr=document.getElementById('sb-header');
  if(!hdr)return;
  var adminBtns=IS_ADMIN
    ?'<div style="display:flex;gap:5px"><button onclick="openShare()" style="background:rgba(255,255,255,.15);color:white;border:none;border-radius:8px;padding:7px 9px;font-size:15px">ğŸ”—</button><button onclick="openAdd()" style="background:#e74c3c;color:white;border:none;border-radius:9px;padding:7px 13px;font-weight:700;font-size:13px">+ ×”×•×¡×£</button></div>'
    :'<button onclick="showLogin()" style="background:rgba(255,255,255,.15);color:white;border:none;border-radius:8px;padding:7px 11px;font-size:12px;font-weight:600">ğŸ”‘ ×›× ×™×¡×”</button>';
  hdr.innerHTML=
    '<div style="display:flex;justify-content:space-between;align-items:center">'+
      '<div>'+
        '<div style="font-size:16px;font-weight:800">ğŸ‡©ğŸ‡ª Berlin Spots</div>'+
        '<div style="display:flex;align-items:center;gap:5px;margin-top:4px">'+
          '<div id="status-dot" style="width:7px;height:7px;border-radius:50%;background:#f39c12;flex-shrink:0"></div>'+
          '<div id="status-text" style="font-size:10px;opacity:.8">×˜×•×¢×Ÿ...</div>'+
        '</div>'+
      '</div>'+
      adminBtns+
    '</div>';
}

// â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFilters() {
  var desktopEl=document.getElementById('sb-filters');
  var mobileEl=document.getElementById('sheet-filters');
  [desktopEl,mobileEl].forEach(function(el){
    if(!el)return;
    el.innerHTML='';
    var allBtn=document.createElement('button');
    allBtn.className='catbtn';
    allBtn.textContent='ğŸ—ºï¸ ×”×›×œ';
    if(FILTER==='all'){allBtn.style.background='#555';allBtn.style.color='white';allBtn.style.borderColor='#555';allBtn.style.fontWeight='700';}
    allBtn.onclick=function(){FILTER='all';renderFilters();renderList();syncMarkers();};
    el.appendChild(allBtn);
    Object.keys(CAT).forEach(function(k){
      var v=CAT[k];
      var b=document.createElement('button');
      b.className='catbtn';
      b.textContent=v.emoji+' '+v.label;
      if(FILTER===k){b.style.background=v.color;b.style.color='white';b.style.borderColor=v.color;b.style.fontWeight='700';}
      b.onclick=function(){FILTER=k;renderFilters();renderList();syncMarkers();};
      el.appendChild(b);
    });
  });
}

// â”€â”€ List (desktop + mobile sheet) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderList() {
  var list=FILTER==='all'?PLACES:PLACES.filter(function(p){return p.category===FILTER;});
  var empty='<div style="padding:40px 20px;text-align:center;color:#ccc"><div style="font-size:48px">ğŸ“</div><div style="font-weight:700;margin-top:8px;color:#bbb">××™×Ÿ ××§×•××•×ª ×¢×“×™×™×Ÿ</div>'+(IS_ADMIN?'<div style="font-size:13px;margin-top:6px;color:#ccc">×œ×—×¥ + ×œ×”×•×¡×™×£ ××§×•×</div>':'')+'</div>';

  function buildRows(container) {
    if(!container)return;
    if(!list.length){container.innerHTML=empty;return;}
    container.innerHTML='';
    list.forEach(function(p){
      var cat=CAT[p.category]||CAT.food;
      var isSel=SEL&&SEL.id===p.id;
      var row=document.createElement('div');
      row.className='row'+(isSel?' sel':'');
      if(isSel)row.style.borderRight='4px solid '+cat.color;
      row.innerHTML=
        '<div style="display:flex;gap:11px;align-items:flex-start">'+
          '<div style="background:'+cat.color+'20;border-radius:10px;width:42px;height:42px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0">'+cat.emoji+'</div>'+
          '<div style="flex:1;min-width:0">'+
            '<div style="font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+esc(p.name)+'</div>'+
            '<div style="font-size:12px;color:#aaa;margin-top:2px">'+(p.date||'')+(p.rating>0?' Â· '+'â˜…'.repeat(p.rating):'')+'</div>'+
            (p.tags&&p.tags.length?'<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:5px">'+p.tags.slice(0,3).map(function(t){return '<span style="background:#f0f0f0;border-radius:7px;padding:2px 8px;font-size:11px;color:#777">'+esc(t)+'</span>';}).join('')+(p.tags.length>3?'<span style="font-size:11px;color:#bbb">+' +(p.tags.length-3)+'</span>':'')+'</div>':'') +
          '</div>'+
        '</div>';
      (function(place){
        row.onclick=function(){
          SEL=place;renderList();renderDetail();syncMarkers();
          if(MAP)MAP.flyTo([place.lat,place.lng],16,{duration:0.5});
          if(IS_MOBILE){collapseSheet();showMobileDetail(place);document.getElementById('tab-map').click();}
        };
      })(p);
      container.appendChild(row);
    });
  }
  buildRows(document.getElementById('sb-list'));
  buildRows(document.getElementById('sheet-list'));
}

// â”€â”€ Detail (desktop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDetail() {
  var el=document.getElementById('detail');
  if(!el)return;
  if(!SEL){el.className='';el.innerHTML='';return;}
  var p=SEL; var cat=CAT[p.category]||CAT.food;
  el.className='on';
  el.style.border='2px solid '+cat.color+'22';
  el.innerHTML=buildDetailHTML(p,cat,true);
}

// â”€â”€ Mobile detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMobileDetail(p) {
  var el=document.getElementById('mobile-detail');
  if(!el)return;
  var cat=CAT[p.category]||CAT.food;
  el.className='on';
  el.innerHTML=buildDetailHTML(p,cat,IS_ADMIN);
  el.style.borderTop='3px solid '+cat.color;
}
function hideMobileDetail() {
  var el=document.getElementById('mobile-detail');
  if(el){el.className='';el.innerHTML='';}
  SEL=null; syncMarkers();
}

function buildDetailHTML(p, cat, showDelete) {
  return '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">'+
    '<div style="display:flex;gap:13px;align-items:flex-start">'+
      '<div style="background:'+cat.color+'20;border-radius:14px;width:52px;height:52px;display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0">'+cat.emoji+'</div>'+
      '<div>'+
        '<div style="font-weight:800;font-size:18px;line-height:1.2">'+esc(p.name)+'</div>'+
        '<div style="font-size:12px;color:#bbb;margin-top:3px">'+cat.label+(p.date?' Â· ğŸ“… '+p.date:'')+'</div>'+
        (p.rating>0?'<div style="color:#f39c12;font-size:20px;margin-top:4px">'+'â˜…'.repeat(p.rating)+'â˜†'.repeat(5-p.rating)+'</div>':'') +
      '</div>'+
    '</div>'+
    '<button onclick="hideMobileDetail();SEL=null;renderDetail();syncMarkers();" style="background:#f0f0f0;border:none;border-radius:10px;width:34px;height:34px;font-size:15px;color:#999;flex-shrink:0">âœ•</button>'+
  '</div>'+
  (p.tags&&p.tags.length?'<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px">'+p.tags.map(function(t){return '<span style="background:'+cat.color+'18;color:'+cat.color+';border-radius:10px;padding:4px 12px;font-size:12px;font-weight:600">'+esc(t)+'</span>';}).join('')+'</div>':'')+
  (p.notes?'<div style="margin-bottom:16px;padding:12px 14px;background:#f8f8f8;border-radius:12px;font-size:14px;color:#444;border-right:3px solid '+cat.color+';line-height:1.6">'+esc(p.notes)+'</div>':'')+
  '<div style="font-size:12px;color:#aaa;font-weight:700;margin-bottom:8px">ğŸ§­ × ×™×•×•×˜</div>'+
  '<div style="display:flex;gap:8px;margin-bottom:16px">'+
    '<a class="navbtn" style="background:#4285F4" href="https://www.google.com/maps/dir/?api=1&destination='+p.lat+','+p.lng+'&travelmode=walking" target="_blank"><span style="font-size:24px">ğŸ—ºï¸</span>Google Maps</a>'+
    '<a class="navbtn" style="background:#00C4C8" href="https://waze.com/ul?ll='+p.lat+','+p.lng+'&navigate=yes" target="_blank"><span style="font-size:24px">ğŸš—</span>Waze</a>'+
    '<a class="navbtn" style="background:#f9a020" href="https://moovitapp.com/index/api/oneclick?dest_lat='+p.lat+'&dest_lon='+p.lng+'&dest_name='+encodeURIComponent(p.name)+'&lang=he-IL" target="_blank"><span style="font-size:24px">ğŸšŒ</span>Moovit</a>'+
  '</div>'+
  (showDelete?'<button onclick="doDelete(\''+p.id+'\')" style="width:100%;padding:12px;border-radius:12px;border:none;background:#fff5f5;color:#e74c3c;font-size:14px;font-weight:600">ğŸ—‘ï¸ ××—×§ ××§×•×</button>':'');
}

function doDelete(id) {
  var p=PLACES.find(function(x){return x.id===id;});
  if(!p||!confirm('×œ××—×•×§ ××ª "'+p.name+'"?'))return;
  var updated=PLACES.filter(function(x){return x.id!==id;});
  setStatus('#f39c12','××•×—×§...');
  writeBin(updated).then(function(){
    PLACES=updated;SEL=null;
    setStatus('#2ecc71',PLACES.length+' ××§×•××•×ª');
    hideMobileDetail();renderList();renderDetail();syncMarkers();
  }).catch(function(e){setStatus('#e74c3c','×©×’×™××”');alert('×©×’×™××ª ××—×™×§×”: '+e.message);});
}

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showModal(html, closeable) {
  var ov=document.getElementById('overlay');
  var box=document.getElementById('modal-box');
  box.className='modal';
  box.innerHTML='<div class="modal-handle"></div>'+html;
  ov.className='on';
  ov.onclick=(closeable!==false)?function(e){if(e.target===ov)closeModal();}:null;
}
function closeModal() {
  document.getElementById('overlay').className='';
  document.getElementById('modal-box').innerHTML='';
  HITS=[];window._sq='';
}

// â”€â”€ Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSetup() {
  showModal(
    '<div style="text-align:center;margin-bottom:22px">'+
      '<div style="font-size:52px">ğŸ‡©ğŸ‡ª</div>'+
      '<div style="font-size:22px;font-weight:800;margin-top:8px">Berlin Spots</div>'+
      '<div style="color:#999;font-size:14px;margin-top:5px">×”×’×“×¨×” ×—×“-×¤×¢××™×ª</div>'+
    '</div>'+
    '<div style="background:#eaf5ff;border-radius:14px;padding:14px 16px;margin-bottom:22px;font-size:13px;color:#1a5276;line-height:1.7">'+
      '<b>×©×œ×‘ 1:</b> ×›× ×¡ ×œ-<a href="https://jsonbin.io" target="_blank" style="color:#2980b9;font-weight:700">jsonbin.io</a> â† ×”×™×¨×©× ×—×™× ×<br/>'+
      '<b>×©×œ×‘ 2:</b> ×œ×—×¥ API Keys â† CREATE ACCESS KEY â† ×”×¢×ª×§<br/>'+
      '<b>×©×œ×‘ 3:</b> ×”×“×‘×§ ×œ××˜×” ×•×‘×—×¨ ×¡×™×¡××”'+
    '</div>'+
    '<label class="lbl">××¤×ª×— API ×-JSONBin:</label>'+
    '<input id="s-key" class="inp" type="text" placeholder="×”×“×‘×§ ×›××Ÿ..." style="font-family:monospace;font-size:13px"/>'+
    '<label class="lbl">×¡×™×¡××ª ×× ×”×œ:</label>'+
    '<input id="s-p1" class="inp" type="password" placeholder="×‘×—×¨ ×¡×™×¡××” (×œ×¤×—×•×ª 4 ×ª×•×•×™×)..."/>'+
    '<label class="lbl">××™××•×ª ×¡×™×¡××”:</label>'+
    '<input id="s-p2" class="inp" type="password" placeholder="×”×–×Ÿ ×©×•×‘..."/>'+
    '<div id="s-err" style="display:none;color:#e74c3c;font-size:13px;margin-bottom:14px;padding:10px 14px;background:#fff5f5;border-radius:10px"></div>'+
    '<button id="s-btn" onclick="doSetup()" class="bigbtn" style="background:linear-gradient(135deg,#1a252f,#2980b9);color:white;margin-bottom:20px">âœ¨ ×¦×•×¨ ××ª ×”××¤×” ×©×œ×™</button>',
    false
  );
}

function doSetup() {
  var key=(document.getElementById('s-key').value||'').trim();
  var p1=(document.getElementById('s-p1').value||'').trim();
  var p2=(document.getElementById('s-p2').value||'').trim();
  var err=document.getElementById('s-err');
  var btn=document.getElementById('s-btn');
  err.style.display='none';
  if(!key){err.style.display='block';err.textContent='× × ×œ×”×–×™×Ÿ ××¤×ª×— API.';return;}
  if(p1.length<4){err.style.display='block';err.textContent='×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 4 ×ª×•×•×™×.';return;}
  if(p1!==p2){err.style.display='block';err.textContent='×”×¡×™×¡×××•×ª ×œ× ×ª×•×××•×ª.';return;}
  btn.disabled=true;btn.innerHTML='<span class="spin"></span> ×™×•×¦×¨...';
  createBin(key,p1).then(function(result){
    CFG={apiKey:key,binId:result.binId,adminHash:result.adminHash,encodedKey:result.encodedKey};
    localStorage.setItem('bs-cfg',JSON.stringify(CFG));
    IS_ADMIN=true;closeModal();startApp();
  }).catch(function(e){
    btn.disabled=false;btn.innerHTML='âœ¨ ×¦×•×¨ ××ª ×”××¤×” ×©×œ×™';
    err.style.display='block';err.textContent=e.message;
  });
}

// â”€â”€ Set Password (upgrade old config) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSetPassword() {
  showModal(
    '<div style="text-align:center;margin-bottom:22px">'+
      '<div style="font-size:44px">ğŸ”</div>'+
      '<div style="font-size:20px;font-weight:800;margin-top:8px">×”×’×“×¨ ×¡×™×¡××ª ×× ×”×œ</div>'+
      '<div style="color:#999;font-size:13px;margin-top:5px">×¦×¢×“ ××—×¨×•×Ÿ ×œ×›× ×™×¡×” ×××›×©×™×¨×™× ××—×¨×™×</div>'+
    '</div>'+
    '<div style="background:#fff9e6;border-radius:12px;padding:12px 16px;margin-bottom:20px;font-size:13px;color:#856404;line-height:1.5">âš ï¸ <b>×©××•×¨ ××ª ×”×¡×™×¡××”!</b> ××™×Ÿ ××¤×©×¨×•×ª ×©×—×–×•×¨.</div>'+
    '<label class="lbl">×¡×™×¡××” ×—×“×©×”:</label>'+
    '<input id="sp-1" class="inp" type="password" placeholder="×‘×—×¨ ×¡×™×¡××”..."/>'+
    '<label class="lbl">××™××•×ª:</label>'+
    '<input id="sp-2" class="inp" type="password" placeholder="×”×–×Ÿ ×©×•×‘..."/>'+
    '<div id="sp-err" style="display:none;color:#e74c3c;font-size:13px;margin-bottom:14px;padding:10px 14px;background:#fff5f5;border-radius:10px"></div>'+
    '<button id="sp-btn" onclick="doSetPassword()" class="bigbtn" style="background:linear-gradient(135deg,#1a252f,#2980b9);color:white;margin-bottom:20px">ğŸ” ×©××•×¨ ×•×”××©×š</button>',
    false
  );
}

function doSetPassword() {
  var p1=(document.getElementById('sp-1').value||'').trim();
  var p2=(document.getElementById('sp-2').value||'').trim();
  var err=document.getElementById('sp-err');
  var btn=document.getElementById('sp-btn');
  err.style.display='none';
  if(p1.length<4){err.style.display='block';err.textContent='×œ×¤×—×•×ª 4 ×ª×•×•×™×.';return;}
  if(p1!==p2){err.style.display='block';err.textContent='×”×¡×™×¡×××•×ª ×œ× ×ª×•×××•×ª.';return;}
  btn.disabled=true;btn.innerHTML='<span class="spin"></span> ×©×•××¨...';
  readBin(CFG.apiKey,CFG.binId).then(function(r){return {places:r.places||[]};})
  .catch(function(){return {places:[]};})
  .then(function(data){
    return sha256(p1).then(function(hash){
      var enc=btoa(CFG.apiKey);
      return fetch(JAPI+'/b/'+CFG.binId,{method:'PUT',headers:{'Content-Type':'application/json','X-Master-Key':CFG.apiKey},body:JSON.stringify({places:data.places,adminHash:hash,encodedKey:enc})})
      .then(function(r){
        if(!r.ok)return r.text().then(function(t){throw new Error('×©×’×™××ª ×©×¨×ª '+r.status);});
        CFG.adminHash=hash;CFG.encodedKey=enc;PLACES=data.places;
        localStorage.setItem('bs-cfg',JSON.stringify(CFG));
        localStorage.setItem('bs-cache',JSON.stringify(PLACES));
        IS_ADMIN=true;closeModal();startApp();
      });
    });
  }).catch(function(e){
    btn.disabled=false;btn.innerHTML='ğŸ” ×©××•×¨ ×•×”××©×š';
    err.style.display='block';err.textContent='×©×’×™××”: '+e.message;
  });
}

// â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLogin(prefillBin) {
  showModal(
    '<div style="text-align:center;margin-bottom:22px">'+
      '<div style="font-size:44px">ğŸ”‘</div>'+
      '<div style="font-size:20px;font-weight:800;margin-top:8px">×›× ×™×¡×ª ×× ×”×œ</div>'+
    '</div>'+
    '<label class="lbl">Bin ID:</label>'+
    '<input id="l-bin" class="inp" type="text" value="'+esc(prefillBin||CFG.binId||'')+'" placeholder="× ××¦× ×‘×œ×™× ×§ ×”×©×™×ª×•×£ ××—×¨×™ bin=..." style="font-family:monospace;font-size:13px"/>'+
    '<label class="lbl">×¡×™×¡××”:</label>'+
    '<input id="l-pass" class="inp" type="password" placeholder="×”×¡×™×¡××” ×©×‘×—×¨×ª..." onkeydown="if(event.key===\'Enter\')doLogin()"/>'+
    '<div id="l-err" style="display:none;color:#e74c3c;font-size:13px;margin-bottom:14px;padding:10px 14px;background:#fff5f5;border-radius:10px"></div>'+
    '<button id="l-btn" onclick="doLogin()" class="bigbtn" style="background:linear-gradient(135deg,#1a252f,#2980b9);color:white;margin-bottom:12px">ğŸ”‘ ×›× ×™×¡×”</button>'+
    '<button onclick="closeModal()" style="width:100%;padding:12px;border-radius:14px;border:none;background:#f5f5f5;color:#888;font-size:14px;margin-bottom:20px">×”××©×š ×‘×§×¨×™××” ×‘×œ×‘×“</button>'
  );
}

function doLogin() {
  var binId=(document.getElementById('l-bin').value||'').trim();
  var pass=(document.getElementById('l-pass').value||'').trim();
  var err=document.getElementById('l-err');
  var btn=document.getElementById('l-btn');
  err.style.display='none';
  if(!binId||!pass){err.style.display='block';err.textContent='× × ×œ××œ× ××ª ×©× ×™ ×”×©×“×•×ª.';return;}
  btn.disabled=true;btn.innerHTML='<span class="spin"></span> ×‘×•×“×§...';
  readBinShare(binId,CFG.encodedKey||'').then(function(record){
    return sha256(pass).then(function(hash){
      if(hash!==record.adminHash)throw new Error('×¡×™×¡××” ×©×’×•×™×”.');
      var apiKey='';try{apiKey=atob(record.encodedKey||'');}catch(e){}
      if(!apiKey)throw new Error('×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨ ××ª ××¤×ª×— ×”-API.');
      CFG={apiKey:apiKey,binId:binId,adminHash:record.adminHash,encodedKey:record.encodedKey};
      localStorage.setItem('bs-cfg',JSON.stringify(CFG));
      IS_ADMIN=true;PLACES=record.places||[];
      localStorage.setItem('bs-cache',JSON.stringify(PLACES));
      closeModal();renderHeader();renderMobileHeader();renderFilters();renderList();setStatus('#2ecc71',PLACES.length+' ××§×•××•×ª');
    });
  }).catch(function(e){
    btn.disabled=false;btn.innerHTML='ğŸ”‘ ×›× ×™×¡×”';
    err.style.display='block';err.textContent=e.message;
  });
}

// â”€â”€ Add Place â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAdd() {
  AF={name:'',category:'food',address:'',lat:null,lng:null,date:new Date().toISOString().slice(0,10),tags:[],notes:'',rating:0};
  HITS=[];SMODE='search';window._sq='';
  renderAddModal();
}

function renderAddModal() {
  var f=AF;
  var catGrid=Object.keys(CAT).map(function(k){
    var v=CAT[k];var a=f.category===k;
    return '<button onclick="AF.category=\''+k+'\';renderAddModal()" style="padding:10px 4px;border-radius:13px;border:2px solid '+(a?v.color:'#eee')+';background:'+(a?v.color+'22':'white')+';font-size:10px;color:'+(a?v.color:'#999')+';font-weight:'+(a?'700':'400')+';text-align:center"><div style="font-size:22px">'+v.emoji+'</div><div style="margin-top:3px">'+v.label+'</div></button>';
  }).join('');

  var hitsHtml='';
  if(HITS.length){
    hitsHtml='<div style="border:1.5px solid #e8e8e8;border-radius:13px;overflow:hidden;max-height:200px;overflow-y:auto;margin-bottom:14px">';
    HITS.forEach(function(r,i){
      hitsHtml+='<div onclick="pickHit('+i+')" style="padding:12px 14px;border-bottom:'+(i<HITS.length-1?'1px solid #f0f0f0':'none')+';cursor:pointer;active:background:#f5f5f5"><div style="font-weight:600;font-size:14px">'+esc(r.name)+'</div><div style="color:#bbb;font-size:12px;margin-top:2px">'+esc(r.address.split(',').slice(0,3).join(','))+'</div></div>';
    });
    hitsHtml+='</div>';
  }

  var searchArea=SMODE==='search'
    ?'<div style="display:flex;gap:8px;margin-bottom:10px"><input id="sq" value="'+esc(window._sq||'')+'" placeholder="×©× ××§×•×, ×¨×—×•×‘..." onkeydown="if(event.key===\'Enter\')doSearch()" style="flex:1;padding:13px 14px;border-radius:12px;border:1.5px solid #e8e8e8;font-size:15px;outline:none"/><button id="s-btn2" onclick="doSearch()" style="background:#2980b9;color:white;border:none;border-radius:12px;padding:0 16px;font-weight:700;font-size:15px;min-width:56px">ğŸ”</button></div><div id="s-err2" style="display:none;color:#c0392b;font-size:13px;padding:10px 13px;background:#fff5f5;border-radius:10px;margin-bottom:10px"></div>'+hitsHtml+(f.lat&&!HITS.length?'<div style="color:#27ae60;font-size:13px;font-weight:600;margin-bottom:12px">âœ… ××™×§×•× × ×‘×—×¨!</div>':'')
    :'<input value="'+esc(f.address)+'" oninput="AF.address=this.value" placeholder="×›×ª×•×‘×ª ××œ××”..." class="inp"/><div style="display:flex;gap:8px;margin-bottom:14px"><input type="number" step="any" value="'+(f.lat||'')+'" oninput="AF.lat=parseFloat(this.value)||null" placeholder="Lat 52.xxx" style="flex:1;padding:12px 13px;border-radius:12px;border:1.5px solid #e8e8e8;font-size:14px;outline:none"/><input type="number" step="any" value="'+(f.lng||'')+'" oninput="AF.lng=parseFloat(this.value)||null" placeholder="Lng 13.xxx" style="flex:1;padding:12px 13px;border-radius:12px;border:1.5px solid #e8e8e8;font-size:14px;outline:none"/></div>';

  var stars=[1,2,3,4,5].map(function(n){return '<span onclick="AF.rating=(AF.rating==='+n+'?0:'+n+');renderAddModal()" style="font-size:32px;cursor:pointer;color:'+(n<=f.rating?'#f39c12':'#e0e0e0')+';line-height:1">â˜…</span>';}).join('');
  var tagsHtml=TAGS.map(function(t){var a=f.tags.indexOf(t)!==-1;return '<button onclick="toggleTag(\''+esc(t)+'\')" class="tag-pill'+(a?' on':'')+'">'+esc(t)+'</button>';}).join('');
  var canSave=f.name&&f.lat;

  showModal(
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">'+
      '<div style="font-size:18px;font-weight:800">ğŸ“ ×”×•×¡×£ ××§×•×</div>'+
      '<button onclick="closeModal()" style="background:#f0f0f0;border:none;border-radius:10px;width:36px;height:36px;font-size:16px;color:#888">âœ•</button>'+
    '</div>'+
    '<label class="lbl">×§×˜×’×•×¨×™×”</label>'+
    '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:20px">'+catGrid+'</div>'+
    '<label class="lbl">×©× ×”××§×•× *</label>'+
    '<input id="af-name" value="'+esc(f.name)+'" oninput="AF.name=this.value" placeholder="Mustafa\'s Kebap" class="inp"/>'+
    '<div style="display:flex;gap:8px;margin-bottom:14px">'+
      '<button onclick="SMODE=\'search\';renderAddModal()" style="flex:1;padding:10px;border-radius:12px;border:1.5px solid '+(SMODE==='search'?'#2980b9':'#e8e8e8')+';background:'+(SMODE==='search'?'#eaf5ff':'white')+';font-size:14px;color:'+(SMODE==='search'?'#2980b9':'#888')+';font-weight:'+(SMODE==='search'?'700':'400')+'">ğŸ” ×—×¤×©</button>'+
      '<button onclick="SMODE=\'manual\';renderAddModal()" style="flex:1;padding:10px;border-radius:12px;border:1.5px solid '+(SMODE==='manual'?'#2980b9':'#e8e8e8')+';background:'+(SMODE==='manual'?'#eaf5ff':'white')+';font-size:14px;color:'+(SMODE==='manual'?'#2980b9':'#888')+';font-weight:'+(SMODE==='manual'?'700':'400')+'">âœï¸ ×™×“× ×™</button>'+
    '</div>'+
    searchArea+
    '<label class="lbl">×ª××¨×™×š</label>'+
    '<input type="date" value="'+(f.date||'')+'" oninput="AF.date=this.value" class="inp"/>'+
    '<label class="lbl">×“×™×¨×•×’</label>'+
    '<div style="display:flex;gap:4px;margin-bottom:18px">'+stars+'</div>'+
    '<label class="lbl">×ª×’×™×•×ª</label>'+
    '<div style="display:flex;gap:7px;flex-wrap:wrap;margin-bottom:18px">'+tagsHtml+'</div>'+
    '<label class="lbl">×”×¢×¨×•×ª</label>'+
    '<textarea oninput="AF.notes=this.value" placeholder="××” ×”×™×” ××™×•×—×“?" rows="3" style="width:100%;padding:12px 14px;border-radius:12px;border:1.5px solid #e8e8e8;font-size:15px;outline:none;resize:vertical;margin-bottom:20px">'+esc(f.notes||'')+'</textarea>'+
    '<button id="af-save" onclick="savePlace()" class="bigbtn" style="background:'+(canSave?'linear-gradient(135deg,#1a252f,#2980b9)':'#e8e8e8')+';color:'+(canSave?'white':'#bbb')+';cursor:'+(canSave?'pointer':'not-allowed')+';margin-bottom:8px">ğŸ“ ×©××•×¨ ××§×•×</button>'
  );
}

function toggleTag(t){var i=AF.tags.indexOf(t);if(i===-1)AF.tags.push(t);else AF.tags.splice(i,1);renderAddModal();}

function pickHit(i){var r=HITS[i];AF.address=r.address;AF.lat=r.lat;AF.lng=r.lng;if(!AF.name)AF.name=r.name;window._sq=r.name;HITS=[];if(MAP)MAP.flyTo([r.lat,r.lng],16,{duration:0.5});renderAddModal();}

function doSearch(){
  var el=document.getElementById('sq');if(!el)return;
  var term=el.value.trim();window._sq=term;if(!term)return;
  var btn=document.getElementById('s-btn2');var errEl=document.getElementById('s-err2');
  if(btn){btn.textContent='...';btn.disabled=true;}
  if(errEl)errEl.style.display='none';
  fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(term)+'&countrycodes=de&viewbox=13.0,52.7,13.8,52.3&bounded=1&limit=8&namedetails=1',{headers:{'Accept-Language':'he,en','User-Agent':'BerlinSpots/1.0'}})
  .then(function(r){return r.json();}).then(function(data){
    if(data.length){HITS=data.map(function(r){return{name:(r.namedetails&&r.namedetails.name)||r.display_name.split(',')[0],address:r.display_name,lat:parseFloat(r.lat),lng:parseFloat(r.lon)};});renderAddModal();return;}
    return fetch('https://photon.komoot.io/api/?q='+encodeURIComponent(term+' Berlin')+'&limit=8').then(function(r){return r.json();}).then(function(d){
      var feats=(d.features||[]).filter(function(f){var c=f.geometry.coordinates;return c[1]>52.3&&c[1]<52.7&&c[0]>13.0&&c[0]<13.8;});
      if(feats.length){HITS=feats.map(function(f){return{name:f.properties.name||f.properties.street||'×œ×œ× ×©×',address:[f.properties.name,f.properties.street,f.properties.city].filter(Boolean).join(', '),lat:f.geometry.coordinates[1],lng:f.geometry.coordinates[0]};});renderAddModal();}
      else{HITS=[];renderAddModal();var e2=document.getElementById('s-err2');if(e2){e2.style.display='block';e2.textContent='×œ× × ××¦×. × ×¡×” ×‘×× ×’×œ×™×ª.';}}
    });
  }).catch(function(){renderAddModal();var e2=document.getElementById('s-err2');if(e2){e2.style.display='block';e2.textContent='×©×’×™××ª ×—×™×¤×•×©.';}});
}

function savePlace(){
  var f=AF;if(!f.name||!f.lat)return;
  var btn=document.getElementById('af-save');
  if(btn){btn.disabled=true;btn.innerHTML='<span class="spin"></span> ×©×•××¨...';}
  var place={id:Date.now().toString(),name:f.name,category:f.category,address:f.address,lat:f.lat,lng:f.lng,date:f.date,tags:f.tags.slice(),notes:f.notes,rating:f.rating};
  writeBin(PLACES.concat([place])).then(function(){
    PLACES=PLACES.concat([place]);SEL=place;
    closeModal();renderList();syncMarkers();
    if(!IS_MOBILE)renderDetail();else showMobileDetail(place);
    setStatus('#2ecc71',PLACES.length+' ××§×•××•×ª');
    if(MAP)MAP.flyTo([place.lat,place.lng],16,{duration:0.5});
  }).catch(function(e){if(btn){btn.disabled=false;btn.innerHTML='ğŸ“ ×©××•×¨ ××§×•×';}alert('×©×’×™××ª ×©××™×¨×”: '+e.message);});
}

// â”€â”€ Share â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openShare(){
  var base=location.href.split('?')[0];
  var k=encodeURIComponent(CFG.encodedKey||btoa(CFG.apiKey||''));
  var shareUrl=base+'?share=1&bin='+CFG.binId+'&k='+k;
  showModal(
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">'+
      '<div style="font-size:18px;font-weight:800">ğŸ”— ×©×ª×£ ××ª ×”××¤×”</div>'+
      '<button onclick="closeModal()" style="background:#f0f0f0;border:none;border-radius:10px;width:36px;height:36px;font-size:16px;color:#888">âœ•</button>'+
    '</div>'+
    '<div style="background:#f0fff6;border-radius:14px;padding:14px 16px;margin-bottom:20px;font-size:13px;color:#1e8449;line-height:1.6">âœ… ×›×œ ××§×•× ×©×ª×•×¡×™×£ ×™×•×¤×™×¢ ××™×“ ×œ×›×œ ××™ ×©×™×¤×ª×— ××ª ×”×œ×™× ×§.</div>'+
    '<input id="share-inp" value="'+esc(shareUrl)+'" readonly onclick="this.select()" style="width:100%;padding:12px 14px;border-radius:12px;border:1.5px solid #e8e8e8;font-size:12px;background:#f8f9fa;color:#666;outline:none;margin-bottom:12px"/>'+
    '<button onclick="doCopy()" id="copy-btn" class="bigbtn" style="background:#2980b9;color:white;margin-bottom:8px">ğŸ“‹ ×”×¢×ª×§ ×œ×™× ×§</button>'+
    '<div style="font-size:12px;color:#bbb;text-align:center;margin-bottom:20px;line-height:1.5">ğŸ‘ï¸ ×”×—×‘×¨×™× ×™×¨××• ××ª ×”××¤×” ×•×™×•×›×œ×• ×œ× ×•×•×˜ â€” ××š ×œ× ×œ×¢×¨×•×š</div>'
  );
}

function doCopy(){
  var inp=document.getElementById('share-inp');var btn=document.getElementById('copy-btn');
  if(!inp||!btn)return;
  navigator.clipboard.writeText(inp.value).then(function(){
    btn.textContent='âœ“ ×”×•×¢×ª×§!';btn.style.background='#27ae60';
    setTimeout(function(){btn.textContent='ğŸ“‹ ×”×¢×ª×§ ×œ×™× ×§';btn.style.background='#2980b9';},2000);
  }).catch(function(){inp.select();document.execCommand('copy');});
}

// â”€â”€ JSONBin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sha256(str){return crypto.subtle.digest('SHA-256',new TextEncoder().encode(str)).then(function(buf){return Array.from(new Uint8Array(buf)).map(function(b){return b.toString(16).padStart(2,'0');}).join('');});}

function apiFetch(path,opts){return fetch(JAPI+path,opts).then(function(r){if(!r.ok)return r.text().then(function(t){throw new Error('×©×’×™××ª ×©×¨×ª '+r.status+': '+t.slice(0,80));});return r.json();});}

function readBin(apiKey,binId){return apiFetch('/b/'+binId+'/latest',{headers:{'X-Master-Key':apiKey}}).then(function(d){return d.record;});}

function writeBin(places){return apiFetch('/b/'+CFG.binId,{method:'PUT',headers:{'Content-Type':'application/json','X-Master-Key':CFG.apiKey},body:JSON.stringify({places:places,adminHash:CFG.adminHash,encodedKey:CFG.encodedKey})});}

function readBinShare(binId,encodedKey){var key='';try{key=atob(decodeURIComponent(encodedKey||''));}catch(e){}var headers={};if(key)headers['X-Master-Key']=key;return apiFetch('/b/'+binId+'/latest',{headers:headers}).then(function(d){return d.record;});}

function createBin(apiKey,password){return sha256(password).then(function(hash){var enc=btoa(apiKey);return apiFetch('/b',{method:'POST',headers:{'Content-Type':'application/json','X-Master-Key':apiKey,'X-Bin-Name':'berlin-spots','X-Bin-Private':'false'},body:JSON.stringify({places:[],adminHash:hash,encodedKey:enc})}).then(function(d){return{binId:d.metadata.id,adminHash:hash,encodedKey:enc};});});}

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#x27;');}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startApp(){
  // Always show the map layout
  document.getElementById('layout').style.display='flex';

  // Show mobile UI elements
  if(IS_MOBILE){
    document.getElementById('mobile-topbar').style.display='flex';
    document.getElementById('mobile-sheet').style.display='flex';
    document.getElementById('mobile-tabs').style.display='flex';
    if(IS_ADMIN) document.getElementById('mobile-fab').style.display='flex';
    initSheetDrag();
  }

  requestAnimationFrame(function(){
    // Make sure map div is in the right container
    initMap();
    if(MAP)MAP.invalidateSize();
    renderHeader();
    renderMobileHeader();
    renderFilters();
    setStatus('#f39c12','×˜×•×¢×Ÿ...');
    readBin(CFG.apiKey,CFG.binId).then(function(record){
      PLACES=record.places||[];
      if(record.adminHash)CFG.adminHash=record.adminHash;
      if(record.encodedKey)CFG.encodedKey=record.encodedKey;
      localStorage.setItem('bs-cfg',JSON.stringify(CFG));
      localStorage.setItem('bs-cache',JSON.stringify(PLACES));
      setStatus('#2ecc71',PLACES.length+' ××§×•××•×ª');
      renderList();syncMarkers();
    }).catch(function(e){
      console.error(e);
      try{PLACES=JSON.parse(localStorage.getItem('bs-cache')||'[]');}catch(ex){}
      setStatus('#e74c3c','×©×’×™××ª ×˜×¢×™× ×”');
      renderList();syncMarkers();
    });
  });
}

function startShareView(binId,encodedKey){
  document.getElementById('layout').style.display='flex';

  if(IS_MOBILE){
    document.getElementById('mobile-topbar').style.display='flex';
    document.getElementById('mobile-sheet').style.display='flex';
    document.getElementById('mobile-tabs').style.display='flex';
    document.getElementById('m-header-btns').innerHTML='<button onclick="showLogin(\''+esc(binId)+'\')" style="background:rgba(255,255,255,.15);color:white;border:none;border-radius:10px;padding:8px 12px;font-size:12px;font-weight:600">ğŸ”‘ ×›× ×™×¡×”</button>';
  } else {
    document.getElementById('layout').style.display='flex';
    document.getElementById('sb-header').innerHTML=
      '<div style="display:flex;justify-content:space-between;align-items:center">'+
        '<div><div style="font-size:15px;font-weight:800">ğŸ‡©ğŸ‡ª Berlin Spots</div>'+
        '<div style="display:flex;align-items:center;gap:5px;margin-top:4px"><div id="status-dot" style="width:7px;height:7px;border-radius:50%;background:#f39c12;flex-shrink:0"></div><div id="status-text" style="font-size:10px;opacity:.8">×˜×•×¢×Ÿ...</div></div></div>'+
        '<button onclick="showLogin(\''+esc(binId)+'\')" style="background:rgba(255,255,255,.15);color:white;border:none;border-radius:8px;padding:7px 11px;font-size:12px;font-weight:600">ğŸ”‘ ×›× ×™×¡×”</button>'+
      '</div>';
  }

  requestAnimationFrame(function(){
    initMap();if(MAP)MAP.invalidateSize();
    renderFilters();
    setStatus('#f39c12','×˜×•×¢×Ÿ...');
    CFG.encodedKey=encodedKey;
    readBinShare(binId,encodedKey).then(function(record){
      PLACES=record.places||[];
      setStatus('#2ecc71',PLACES.length+' ××§×•××•×ª');
      renderList();syncMarkers();
    }).catch(function(e){
      setStatus('#e74c3c','×©×’×™××ª ×˜×¢×™× ×”');
      var msg='<div style="padding:24px;font-size:14px;color:#c0392b;line-height:1.7"><b>âš ï¸ ×©×’×™××ª ×˜×¢×™× ×”</b><br/><br/>'+esc(e.message)+'<br/><br/>×•×“× ×©×”×œ×™× ×§ ×©×œ× ×•×œ× × ×—×ª×š.</div>';
      var el=IS_MOBILE?document.getElementById('sheet-list'):document.getElementById('sb-list');
      if(el)el.innerHTML=msg;
    });
  });
}

// â”€â”€ Entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var params=new URLSearchParams(location.search);
if(params.get('share')==='1'){
  var binId=params.get('bin');
  var encodedKey=params.get('k')||'';
  if(binId)startShareView(binId,encodedKey);
  else document.body.innerHTML='<div style="padding:40px;text-align:center;color:#888">×œ×™× ×§ ×œ× ×ª×§×™×Ÿ</div>';
} else if(CFG.apiKey&&CFG.binId&&CFG.adminHash){
  IS_ADMIN=true;startApp();
} else if(CFG.apiKey&&CFG.binId&&!CFG.adminHash){
  showSetPassword();
} else {
  showSetup();
}
</script>
</body>
</html>
